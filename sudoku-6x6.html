<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>6x6 Pearl Sudoku</title>

<style>
:root {
  --bg-color: #dbe7e0;
  --grid-color: #b3d1c2;
  --button-color: #b3d1c2;
  --button-text: #000;
  --font-color: #000;
  --overlay-text: rgba(0,0,0,0.65);
  --selection-color: rgba(60, 90, 140, 0.35);
}

body {
  margin: 0;
  padding: 100px 20px 20px 20px;
  font-family: sans-serif;
  background: var(--bg-color);
  color: var(--font-color);
  display: flex;
  justify-content: center;
}

.app { max-width: 360px; width: 100%; }

.title {
  text-align: center;
  font-size: 20px;
  margin: 20px 0 24px 0;
}

.grid-wrapper {
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;
  margin-bottom: 16px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  grid-template-rows: repeat(6, 1fr);
  width: 100%;
  height: 100%;
  background: white;
  border: 2px solid var(--grid-color);
}

.cell {
  border: 1px solid var(--grid-color);
  display: flex;
  align-items: center;
  justify-content: center;
}

.cell.major-right { border-right: 3px solid var(--grid-color); }
.cell.major-bottom { border-bottom: 3px solid var(--grid-color); }

.cell img { width: 78%; height: 78%; object-fit: contain; }

.cell.selected { background: var(--selection-color); }

.overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 42px;
  color: var(--overlay-text);
  opacity: 0;
  transition: opacity 0.6s;
}

.palette {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  margin-bottom: 16px;
}

.palette img {
  width: 100%;
  aspect-ratio: 1 / 1;
  object-fit: contain;
}

.controls { display: flex; gap: 12px; }

button {
  flex: 1;
  padding: 10px;
  border-radius: 10px;
  border: none;
  background: var(--button-color);
  color: var(--button-text);
}

.dots {
  display: flex;
  justify-content: center;
  gap: 6px;
  margin-top: 10px;
}

.dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(0,0,0,0.25);
}

.dot.active { background: rgba(0,0,0,0.6); }
</style>
</head>

<body>
<div class="app">
  <div class="title" id="gameTitle">Loading...</div>

  <div class="grid-wrapper" id="swipeArea">
    <div class="grid" id="grid"></div>
    <div class="overlay" id="overlayText"></div>
  </div>

  <div class="palette" id="palette"></div>

  <div class="controls">
    <button onclick="undo()">Undo</button>
    <button onclick="resetGrid()">Clear</button>
  </div>

  <div class="dots" id="dots"></div>
</div>

<script>
const SUPABASE_URL = "https://tppyzexttkuvcobbbmaz.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_VZiTsc0JGVx6tVf2Zu-9uQ_-FwjGpQW";

let games = [];
let currentIndex = 0;

let images = [null];
let startPuzzle = [];
let puzzle = [];
let history = [];
let selectedCell = null;

const gridEl = document.getElementById("grid");
const paletteEl = document.getElementById("palette");
const overlay = document.getElementById("overlayText");
const dotsEl = document.getElementById("dots");

async function loadGames() {
  const response = await fetch(
    `${SUPABASE_URL}/rest/v1/GamesSudoku?grid_size=eq.6&order=created_at.desc`,
    {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`
      }
    }
  );

  const data = await response.json();
  games = data;
  if (!games.length) return;

  initGame(0);
  buildDots();
}

function initGame(index) {
  currentIndex = index;
  const game = games[index];

  // Parse JSON fields from Supabase
  const parsedGrid = JSON.parse(game.GridJson);
  const parsedImages = JSON.parse(game.ImagesJson);

  images = [null];
  for (let i = 1; i <= 6; i++) {
    images[i] = parsedImages[i];
  }

  startPuzzle = parsedGrid;
  puzzle = JSON.parse(JSON.stringify(startPuzzle));
  history = [];

  // Optional: apply colors dynamically
  document.documentElement.style.setProperty('--bg-color', game.BgColor);
  document.documentElement.style.setProperty('--grid-color', game.GridColor);
  document.documentElement.style.setProperty('--button-color', game.ButtonColor);
  document.documentElement.style.setProperty('--button-text', game.ButtonTextColor);
  document.documentElement.style.setProperty('--font-color', game.FontColor);

  document.getElementById("gameTitle").textContent = game.Name;

  buildGrid();
  buildPalette();
  updateDots();
}

  
function buildGrid() {
  gridEl.innerHTML = "";
  puzzle.forEach((row, r) => {
    row.forEach((val, c) => {
      const cell = document.createElement("div");
      cell.className = "cell";
      if ((c + 1) % 3 === 0 && c !== 5) cell.classList.add("major-right");
      if ((r + 1) % 2 === 0 && r !== 5) cell.classList.add("major-bottom");

      if (val) {
        const img = document.createElement("img");
        img.src = images[val];
        cell.appendChild(img);
      } else {
        cell.addEventListener("click", () => selectCell(cell));
      }

      cell.dataset.row = r;
      cell.dataset.col = c;
      gridEl.appendChild(cell);
    });
  });
}

function buildPalette() {
  paletteEl.innerHTML = "";
  for (let i = 1; i <= 6; i++) {
    const img = document.createElement("img");
    img.src = images[i];
    img.onclick = () => placePearl(i);
    paletteEl.appendChild(img);
  }
}

function buildDots() {
  dotsEl.innerHTML = "";
  games.forEach((_, i) => {
    const dot = document.createElement("div");
    dot.className = "dot";
    dotsEl.appendChild(dot);
  });
  updateDots();
}

function updateDots() {
  document.querySelectorAll(".dot").forEach((dot, i) => {
    dot.classList.toggle("active", i === currentIndex);
  });
}

function nextGame() {
  let next = (currentIndex + 1) % games.length;
  initGame(next);
}

function prevGame() {
  let prev = (currentIndex - 1 + games.length) % games.length;
  initGame(prev);
}

let startX = 0;

document.getElementById("swipeArea").addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
});

document.getElementById("swipeArea").addEventListener("touchend", e => {
  let diff = e.changedTouches[0].clientX - startX;
  if (diff > 50) prevGame();
  if (diff < -50) nextGame();
});

function selectCell(cell) {
  document.querySelectorAll(".cell").forEach(c => c.classList.remove("selected"));
  cell.classList.add("selected");
  selectedCell = cell;
}

function placePearl(val) {
  if (!selectedCell) return;
  const r = selectedCell.dataset.row;
  const c = selectedCell.dataset.col;
  history.push(JSON.parse(JSON.stringify(puzzle)));
  puzzle[r][c] = val;
  buildGrid();
}

function undo() {
  if (!history.length) return;
  puzzle = history.pop();
  buildGrid();
}

function resetGrid() {
  puzzle = JSON.parse(JSON.stringify(startPuzzle));
  history = [];
  buildGrid();
}

loadGames();
</script>
</body>
</html>
