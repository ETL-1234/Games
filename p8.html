<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --bg-color: #829593;
}

body {
  margin: 0;
  font-family: "Inter", Arial, sans-serif;
  background: var(--bg-color);
  display: flex;
  justify-content: center;
  overflow: hidden;
}

.app {
  width: 100%;
  max-width: 500px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ===== TOP DOTS ===== */
.dots {
  display: flex;
  gap: 6px;
  margin-top: 18px;
  margin-bottom: 12px;
}

.dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(0,0,0,0.25);
}

.dot.active {
  background: rgba(0,0,0,0.65);
}

/* ===== TITLE ===== */
h1 {
  margin: 0 0 16px 0;
  font-size: 20px;
}

/* ===== BOARD ===== */
.board {
  width: 90vmin;
  height: 90vmin;
  position: relative;
  touch-action: none;
}

.tile {
  position: absolute;
  width: calc(100% / 3);
  height: calc(100% / 3);
  transition: transform 160ms ease-out;
  overflow: hidden;
  border-radius: 6px;
}

.tile img {
  width: 300%;
  height: 300%;
  position: absolute;
  pointer-events: none;
}

.shuffle {
  width: 44px;
  height: 44px;
  border-radius: 22px;
  background: rgba(255,255,255,0.3);
  margin: 20px 0 30px 0;
}
</style>
</head>

<body>
<div class="app">

<div class="dots" id="dots"></div>
<h1 id="puzzleTitle">Loading...</h1>
<div class="board" id="board"></div>
<div class="shuffle" id="shuffle"></div>

</div>

<script>
/* ================= SUPABASE ================= */

const SUPABASE_URL = "https://YOUR_PROJECT_ID.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";

let puzzles = [];
let currentIndex = 0;
let IMAGE_URL = "";

/* ================= LOAD PUZZLES ================= */

async function loadPuzzles() {
  const response = await fetch(
    `${SUPABASE_URL}/rest/v1/puzzle?type=eq.3X3&active=eq.true&limit=5`,
    {
      headers: {
        apikey: SUPABASE_ANON_KEY,
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`
      }
    }
  );

  puzzles = await response.json();

  if (!puzzles.length) {
    document.getElementById("puzzleTitle").textContent = "No Puzzles Found";
    return;
  }

  buildDots();
  initPuzzle(0);
}

/* ================= INIT PUZZLE ================= */

function initPuzzle(index) {
  currentIndex = index;
  const puzzle = puzzles[index];

  IMAGE_URL = puzzle.imageurl;

  document.documentElement.style.setProperty('--bg-color', puzzle.bgcolor);
  document.getElementById("puzzleTitle").textContent = puzzle.name;

  updateDots();
  shuffle();
}

/* ================= DOTS ================= */

function buildDots() {
  const dotsEl = document.getElementById("dots");
  dotsEl.innerHTML = "";
  puzzles.forEach(() => {
    const dot = document.createElement("div");
    dot.className = "dot";
    dotsEl.appendChild(dot);
  });
}

function updateDots() {
  document.querySelectorAll(".dot").forEach((dot, i) => {
    dot.classList.toggle("active", i === currentIndex);
  });
}

/* ================= SWIPE BETWEEN PUZZLES ================= */

let startX = 0;

document.body.addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
});

document.body.addEventListener("touchend", e => {
  let diff = e.changedTouches[0].clientX - startX;

  if (diff > 60) prevPuzzle();
  if (diff < -60) nextPuzzle();
});

function nextPuzzle() {
  let next = (currentIndex + 1) % puzzles.length;
  initPuzzle(next);
}

function prevPuzzle() {
  let prev = (currentIndex - 1 + puzzles.length) % puzzles.length;
  initPuzzle(prev);
}

/* ================= PUZZLE LOGIC ================= */

const GRID = 3;
let board = [];

function solvedBoard() {
  return [...Array(GRID * GRID).keys()];
}

function neighbors(index) {
  const r = Math.floor(index / GRID);
  const c = index % GRID;
  const n = [];
  if (r > 0) n.push(index - GRID);
  if (r < GRID - 1) n.push(index + GRID);
  if (c > 0) n.push(index - 1);
  if (c < GRID - 1) n.push(index + 1);
  return n;
}

function shuffle() {
  board = solvedBoard();
  let empty = board.length - 1;

  for (let i = 0; i < 15; i++) {
    const options = neighbors(empty);
    const move = options[Math.floor(Math.random() * options.length)];
    [board[empty], board[move]] = [board[move], board[empty]];
    empty = move;
  }

  render();
}

function moveBySwipe(direction) {
  const e = board.indexOf(0);
  const r = Math.floor(e / GRID);
  const c = e % GRID;

  let target = null;
  if (direction === "up" && r < GRID - 1) target = e + GRID;
  if (direction === "down" && r > 0) target = e - GRID;
  if (direction === "left" && c < GRID - 1) target = e + 1;
  if (direction === "right" && c > 0) target = e - 1;

  if (target === null) return;

  [board[e], board[target]] = [board[target], board[e]];
  render();
}

const boardEl = document.getElementById("board");

boardEl.addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
});

boardEl.addEventListener("touchend", e => {
  const dx = e.changedTouches[0].clientX - startX;
  if (Math.abs(dx) < 30) return;
  moveBySwipe(dx > 0 ? "right" : "left");
});

function render() {
  boardEl.innerHTML = "";

  board.forEach((tile, index) => {
    if (tile === 0) return;

    const el = document.createElement("div");
    el.className = "tile";

    const r = Math.floor(index / GRID);
    const c = index % GRID;
    el.style.transform = `translate(${c * 100}%, ${r * 100}%)`;

    const img = document.createElement("img");
    const ir = Math.floor((tile - 1) / GRID);
    const ic = (tile - 1) % GRID;
    img.src = IMAGE_URL;
    img.style.left = `-${ic * 100}%`;
    img.style.top = `-${ir * 100}%`;

    el.appendChild(img);
    boardEl.appendChild(el);
  });
}

document.getElementById("shuffle").addEventListener("click", shuffle);

loadPuzzles();
</script>
</body>
</html>
